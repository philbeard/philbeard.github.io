<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="css/display.css">
<script type="text/javascript" src="res/js/jquery-3.0.0.min.js"></script>
<script type="text/javascript" src="res/js/common.js"></script>
<title>Phils Page</title>
</head>
<body class="body">
<div class="header">
	<h1>Welcome to Phils portfolio</h1>
</div>
<div class="main_content">
    <h1>Things I did for fun:</h1>
	<div class="main_content">
	    	<div id="games">
		<a href="http://philbeard.site88.net/adventuresofjake/" img="res/jakebro.jpg">
			<img border="2" alt="cool stuff" src="res/jakebro.jpg" width="200" height="200">
		</a>
		</div>
	</div>
</div>
<div>
	<h1>Useful snippets</h1>
	<input type='button' id='toggle' value='CSV to Email'>
	<div class="code" id="csv"><pre>
	<p>
	// array of email addresses.
	$to = array();
	
	function array2csv(array &$array)
	{
	   if (count($array) == 0) {
	     return null;
	   }
	   $df = fopen("/tmp/report_".date('Y-m-d', strtotime("-1 days")).".csv", 'w');
	   fputcsv($df, array_keys(reset($array)));
	   foreach ($array as $row) {
	      fputcsv($df, $row);
	   }
	   fclose($df);
	}
	
	function getData(){
	        $return = array();
	        $dbDetails = readConfig();
	        $table = '';
	        $query = "SELECT ";
	        $query .= "FROM ";
	        $conn = new mysqli($dbDetails[server], $dbDetails[user], $dbDetails[pass], $dbDetails[database]);
	        $result = $conn->query($query);
	        while ($row = $result->fetch_assoc()){
	                $return[] = $row;
	        }
			$conn->close();
	        return $return;
	}
	
	function emailCsv($csv_path, $body, $to = 'phil@email.co.uk', $subject = 'CSV Report data', $from = 'support@email.co.uk') {
	        $logopt = '';
	        $subject = escapeshellarg($subject);
	        $attachment_path = escapeshellarg($csv_path);
	        file_put_contents("/tmp/email.txt", $body);
	        $txtfile = escapeshellarg("/tmp/email.txt");
	        $from = escapeshellarg($from);
	        foreach($to as $singleEmail){
	                $emailto = escapeshellarg($singleEmail);
	                `/usr/local/bin/sendEmail $logopt -q -f $from -t $emailto -u $subject -a $attachment_path -o "message-file="$txtfile`;
	        }
	}
	
	$data = getData();
	
	$body = "Please see attached CSV for " . date('Y-m-d', strtotime("-1 days"));
	array2csv($data);
	
	emailCsv("/tmp/report_".date('Y-m-d', strtotime("-1 days")).".csv", $body, $to);
	</p>
	</div>
	</pre>
</div>
</body>
</html>
